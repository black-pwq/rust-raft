syntax = "proto3";

package raft;

// Raft RPCs from Figure 2 in the Raft paper (leader election & log replication).
// Implementations rely on Raft's state machine: followers respond, candidates solicit
// votes, leaders replicate logs and act as heartbeats.
service Raft {
	// Invoked by candidates to gather votes (§5.2).
	rpc RequestVote (RequestVoteArgsPb) returns (RequestVoteReplyPb);
	// Invoked by leader to replicate log entries (§5.3); also used as heartbeat (§5.2).
	rpc AppendEntries (AppendEntriesArgsPb) returns (AppendEntriesReplyPb);
	// Invoked by clients to submit commands to the cluster.
	// rpc ClientCommand (ClientRequest) returns (ClientReply);
}

message AppendEntriesArgsPb {
	// Leader's current term; follower updates if lower.
	uint32 term = 1;
	// So follower can redirect clients to current leader.
	uint32 leader_id = 2;
	// Index & term of log entry immediately preceding new ones (consistency check).
	uint32 prev_log_index = 3;
	uint32 prev_log_term = 4;
	// Log entries to store (empty when sending heartbeat).
	repeated LogEntryPb entries = 5;
	// Leader’s commit index so follower can advance commit index.
	uint32 leader_commit = 6;
}
message AppendEntriesReplyPb {
	// Current term for leader to update itself.
	uint32 term = 1;
	// True if follower contained matching prev_log_index and prev_log_term.
	bool success = 2;
}
message LogEntryPb {
	// Term when entry was received by leader.
	uint32 term = 1;
	// State machine command (KV-specific, structured).
	KvCommand command = 2;
}

// KV commands encoded into the Raft log.
message KvGet {
	string key = 1;
}

message KvSet {
	string key = 1;
	string value = 2;
}

message KvCommand {
	oneof cmd {
		KvGet get = 1;
		KvSet set = 2;
	}
}

message RequestVoteArgsPb {
	// Candidate’s term.
	uint32 term = 1;
	// Candidate requesting vote.
	uint32 candidate_id = 2;
	// Index/term of candidate’s last log entry (up-to-dateness check).
	uint32 last_log_index = 3;
	uint32 last_log_term = 4;
}
message RequestVoteReplyPb {
	// Current term for candidate to update itself.
	uint32 term = 1;
	// True means candidate received vote.
	bool vote_granted = 2;
}	

// KV command types
enum CommandType {
	GET = 0;
	SET = 1;
}

// Client request to submit a KV command to the Raft cluster.
message ClientRequest {
	// The type of command (GET or SET).
	CommandType command_type = 1;
	// The key to operate on.
	string key = 2;
	// The value to set (only for SET commands).
	string value = 3;
}

// Client reply after command has been applied or an error occurred.
message ClientReply {
	// True if the command was successfully applied.
	bool success = 1;
	// Error message if success is false.
	string error = 2;
	// The leader ID if this node is not the leader (for client redirection).
	uint32 leader_id = 3;
	// The value retrieved (only for successful GET commands).
	string value = 4;
}
